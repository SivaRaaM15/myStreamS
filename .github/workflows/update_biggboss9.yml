name: Update Bigg Boss Tamil S9 - watching Stream

on:
  schedule:
    - cron: '0 12 * * *'  # Daily at 12:00 PM MYT
  workflow_dispatch:

jobs:
  update-watching-stream:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y curl grep sed

    - name: Download current M3U
      run: |
        curl -fsSL --max-time 30 "https://raw.githubusercontent.com/SivaRaaM15/myStreamS/refs/heads/main/sivarenu.m3u" -o sivarenu.m3u

    - name: Update watching stream with confirmed working source
      run: |
        # Backup
        cp sivarenu.m3u sivarenu.m3u.bak

        # === CONFIRMED WORKING IN VLC (Nov 06, 2025) ===
        NEW_STREAM_URL="https://www.dailymotion.com/cdn/manifest/video/x9t9dx0.m3u8?sec=UV4SfRj1FI_DLyWL7oU0P1-NZjaV2ba8UoJC5P7VA2_Oc0jbDSIop6lZtocSSshTKDv7Av1A4iRQmlZz5MskqLubzvbzZPNumrD3UMlsilHaME5ti9BThLFClVZjrAKU&dmTs=430000&dmV1st=359cf258-fa2a-4886-9464-e75bca2af369"

        # === SCRAPE LATEST DAY FROM CATEGORY PAGE ===
        HEADERS="-A 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' -H 'Accept: text/html'"

        CATEGORY_PAGE=$(curl -s $HEADERS --max-time 30 "https://www.1tamilcrow.net/category/bigg-boss-live-stream/" || echo "")

        if [ -n "$CATEGORY_PAGE" ]; then
          POST_TITLE=$(echo "$CATEGORY_PAGE" | grep -oE '<h2 class="entry-title">[^<]*' | head -1 | sed 's/<h2 class="entry-title">//' | xargs || echo "Bigg Boss Tamil S9 Latest")
          DAY_MATCH=$(echo "$POST_TITLE" | grep -oE 'Day [0-9]+' | tail -1 || echo "Latest")
        else
          POST_TITLE="Bigg Boss Tamil S9 Latest"
          DAY_MATCH="Latest"
        fi

        NEW_TITLE="watching - BB S9 $DAY_MATCH"

        echo "Post title: '$POST_TITLE'"
        echo "New title: $NEW_TITLE"
        echo "Using confirmed stream: $NEW_STREAM_URL"

        # Update title
        sed -i.bak "s|tvg-id=\"watching \",.*|tvg-id=\"watching \",$NEW_TITLE|" sivarenu.m3u

        # Update URL
        sed -i.bak '/tvg-id="watching "/{n; s|.*|'"$NEW_STREAM_URL"'|}' sivarenu.m3u

        echo "Update applied."

    - name: Commit and push
      run: |
        git config user.name "StreamBot"
        git config user.email "streambot@users.noreply.github.com"

        if ! git diff --quiet sivarenu.m3u; then
          git add sivarenu.m3u
          DAY_INFO=$(grep 'tvg-id="watching "' sivarenu.m3u | sed 's|.*BB S9 ||' | head -c 20)
          git commit -m "Update watching to BB S9 $DAY_INFO"
          git push origin main && echo "Pushed." || { echo "Push failed."; exit 1; }
        else
          echo "No changes."
        fi

    - name: Upload M3U
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: m3u-files
        path: |
          sivarenu.m3u
          sivarenu.m3u.bak
        retention-days: 3
